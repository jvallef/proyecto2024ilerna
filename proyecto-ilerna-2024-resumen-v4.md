# Proyecto Ilerna 2024 (EduPlazza) - Resumen de Desarrollo

## üìã Visi√≥n General del Proyecto

### Objetivo del Proyecto
- Crear un repositorio educativo jer√°rquico
- Gestionar contenido formativo de manera estructurada
- Implementar un sistema de usuarios con roles diferenciados

### Estado Actual
- Fase: MVP
- Backend: Laravel 11 con SQLite
- Frontend: Tailwind CSS + Laravel Breeze + Alpine.js
- Gesti√≥n de roles: Spatie Laravel-Permission
- Gesti√≥n de im√°genes y archivos: Spatie Media Library
- Sistema de pruebas: PHPUnit con TestCase personalizado
- Url desarrollo: https://proyecto2024ilerna.test

### Estructura Principal
- Areas: √Åreas de conocimiento
- Paths: Rutas de aprendizaje
- Courses: Cursos
- Contents: Contenidos
- Users y Roles: Sistema de usuarios y roles
- Media: Gesti√≥n de im√°genes y archivos

### Estado de Implementaci√≥n

#### Componentes Reutilizables
##### Search Autocomplete
- Componente: `search-autocomplete.blade.php`
- Tecnolog√≠as: Alpine.js + Laravel
- Caracter√≠sticas:
  - B√∫squeda din√°mica con debounce (300ms)
  - Sugerencias en tiempo real
  - Navegaci√≥n por teclado (flechas arriba/abajo)
  - Formato personalizado de sugerencias (nombre + email)
  - Separador seguro || para datos compuestos
  - Bot√≥n de limpieza (x) din√°mico
  - Indicador de carga
  - Soporte para b√∫squeda flexible (OR) en m√∫ltiples campos
- Implementaci√≥n:
  ```blade
  <x-search-autocomplete
      :route="route('admin.users.index')"
      :search-url="route('admin.api.search.users')"
      :placeholder="__('Buscar usuarios...')"
      :min-chars="2"
  />
  ```

##### Avatar Upload
- Componente: `avatar-upload.blade.php`
- Caracter√≠sticas:
  - Previsualizaci√≥n en tiempo real
  - Validaci√≥n de dimensiones y tama√±o
  - Soporte para drag & drop
  - Mensajes de error personalizados
  - L√≠mites configurables v√≠a .env

#### Modelos Implementados
- `User`: Implementado completamente
  - Autenticaci√≥n y roles
  - Avatar con trait HasAvatar
  - B√∫squeda avanzada por nombre/email
  - Soft deletes
  - Validaciones completas

- `Area`: En desarrollo
  - Modelo base con relaciones (parent/children, paths, user, medias)
  - Traits implementados:
    - GeneratesSlug: Generaci√≥n autom√°tica de slugs √∫nicos
    - HasMediaTrait: Gesti√≥n de im√°genes
    - SoftDeletes: Borrado suave
  - Validaciones espec√≠ficas:
    - Nombre √∫nico y obligatorio
    - Jerarqu√≠a sin ciclos
    - Metadatos SEO opcionales
  - API de b√∫squeda implementada:
    - Endpoint: `/admin/api/search/areas`
    - B√∫squeda por nombre y descripci√≥n
    - Formato de sugerencias personalizado
  - Servicio dedicado (`AreaService`):
    - Gesti√≥n de jerarqu√≠a
    - Control de ordenamiento (sort_order)
    - Manejo de metadatos
    - Gesti√≥n transaccional de operaciones

- `Content`: Archivo base creado
- `Course`: Archivo base creado
- `Media`: Implementado para gesti√≥n de avatares y archivos
- `Message`: Archivo base creado
- `Path`: Archivo base creado

#### Controladores
- `UserController`: CRUD completo con b√∫squeda avanzada
- `UserSearchController`: API de b√∫squeda con sugerencias
- `AreaController`: En desarrollo
  - Rutas administrativas configuradas
  - Middleware de autorizaci√≥n implementado
  - API de b√∫squeda con `AreaSearchController`
- `ProfileController`: Implementado para gesti√≥n de perfiles
- `ImageController`: Implementado para manejo de avatares y validaci√≥n
- Controladores de autenticaci√≥n en carpeta Auth

#### Sistema de Archivos y Media
- Implementaci√≥n de subida de avatares con validaci√≥n
- L√≠mites configurables en .env:
  - AVATAR_MAX_FILE_SIZE=2048 (KB)
  - AVATAR_MAX_DIMENSIONS=3000 (pixels)
- Tipos de archivo permitidos: jpg, jpeg, png, webp
- Almacenamiento en disco p√∫blico con nombres √∫nicos
- Trait HasAvatar para manejo de avatares en User

#### Sistema de Testing
- Tests de Feature:
  - `UserAvatarValidationTest`: Validaci√≥n completa de avatares
  - `SlugGenerationTest`: Generaci√≥n de slugs para URLs
  - `ImageControllerTest`: Manejo de im√°genes
  - `ProfileTest`: Funcionalidad de perfiles
  - Tests completos de autenticaci√≥n (registro, login, reset, etc.)

#### API y Endpoints
- B√∫squeda de Usuarios:
  - Endpoint: `/admin/api/search/users`
  - Controlador: `UserSearchController`
  - Caracter√≠sticas:
    - B√∫squeda en m√∫ltiples campos
    - Formato de sugerencias personalizado
    - Separador seguro || para datos compuestos
    - Logging detallado para debugging
    - B√∫squeda flexible con OR

- B√∫squeda de √Åreas:
  - Endpoint: `/admin/api/search/areas`
  - Controlador: `AreaSearchController`
  - Caracter√≠sticas:
    - B√∫squeda por nombre y descripci√≥n
    - Formato de sugerencias personalizado
    - L√≠mite de 10 resultados
    - Ordenamiento por nombre
    - Logging para debugging

#### Rutas y Permisos
- Rutas de autenticaci√≥n configuradas
- Rutas para √°reas:
  - P√∫blicas: `/areas` (index, show)
  - Admin: `/admin/areas` (CRUD completo)
- Middleware para roles (admin, teacher, student)
- Prefijos de rutas por rol (/admin, /workarea, /classroom)
- Middleware `ensureRole` implementado
- Soporte para m√∫ltiples roles en rutas

#### Pendiente de Implementaci√≥n
- Vistas administrativas para Areas
- Vistas p√∫blicas para contenido
- Implementaci√≥n completa de modelos Path, Course y Content
- Sistema de mensajes (Message model)
- Pruebas unitarias adicionales para nuevos modelos

### Pr√≥ximos Pasos

1. Gesti√≥n de √Åreas _(En Progreso)_
   - ‚úÖ Rutas administrativas configuradas
   - ‚úÖ API de b√∫squeda implementada
   - ‚úÖ Validaciones y reglas de negocio
   - ‚úÖ Servicio de gesti√≥n implementado
   - üîÑ Implementar vistas administrativas
   - Implementar ordenamiento drag & drop
   - Adaptar componentes de media

2. Gesti√≥n de Rutas (Paths) _(Prioridad Media)_
   - Crear CRUD b√°sico
   - Implementar relaciones con √°reas
   - Adaptar componentes de b√∫squeda y media
   - Sistema de ordenaci√≥n y jerarqu√≠a

3. Sistema de Archivos _(Prioridad Media)_
   - Extender sistema actual de media
   - Implementar gesti√≥n por √°rea/ruta
   - A√±adir validaciones espec√≠ficas por tipo
   - Gesti√≥n de permisos por tipo de archivo

4. Mejoras de UX _(Prioridad Baja)_
   - A√±adir filtros adicionales en b√∫squedas
   - Mejorar feedback visual
   - Optimizar rendimiento de componentes
   - Mejorar accesibilidad

## Proceso de Revisi√≥n y Refactorizaci√≥n de M√≥dulos

### 1. An√°lisis Inicial
1. **B√∫squeda de Archivos Relacionados**:
   ```bash
   # Buscar todos los archivos relacionados con el m√≥dulo
   find app -name "*Area*.php"
   find database/migrations -name "*areas*.php"
   ```
   - Revisar controladores (Public, Api, etc.)
   - Identificar modelos y relaciones
   - Localizar migraciones
   - Encontrar requests y services

2. **Revisi√≥n de Migraciones**:
   - Examinar estructura de tablas
   - Verificar tipos de campos y restricciones
   - Comprobar √≠ndices y claves for√°neas
   - Validar soft deletes y timestamps
   - Asegurar consistencia con otros m√≥dulos relacionados

3. **An√°lisis de Modelo**:
   - Confirmar traits necesarios (HasMedia, SoftDeletes)
   - Verificar fillable/guarded
   - Revisar relaciones con otros modelos
   - Comprobar scopes y m√©todos auxiliares
   - Asegurar que las relaciones coinciden con migraciones

4. **Revisi√≥n de Requests**:
   - Validar reglas contra campos de migraci√≥n
   - Implementar validaciones de archivos
   - Usar variables de entorno para configuraci√≥n
   - A√±adir mensajes de error personalizados
   - Prevenir referencias circulares si aplica

### 2. Implementaci√≥n de Controladores
1. **Estructura de M√©todos**:
   - public* (acceso p√∫blico)
   - private* (acceso admin)
   - educa* (acceso plataforma)

2. **Configuraci√≥n**:
   - Middleware y roles
   - Inyecci√≥n de servicios
   - Variables de entorno (paginaci√≥n, etc.)

3. **Estandarizaci√≥n**:
   - Manejo consistente de errores
   - Logging estructurado
   - Respuestas JSON para API
   - Redirecciones y mensajes flash

### 3. Servicios y Helpers
1. **Services**:
   - L√≥gica de negocio centralizada
   - Manejo de transacciones
   - Gesti√≥n de archivos/media
   - Ordenamiento y jerarqu√≠as

2. **API Controllers**:
   - Endpoints de b√∫squeda
   - Validaciones espec√≠ficas
   - Transformaci√≥n de datos

### 4. Variables de Entorno
1. **Configuraci√≥n de Media**:
   ```env
   # Ejemplo para Areas
   COVER_ALLOWED_TYPES="jpg,jpeg,png,webp"
   COVER_MAX_FILE_SIZE=2048
   COVER_MAX_DIMENSIONS=2000
   ```

2. **Configuraci√≥n General**:
   ```env
   PAGINATION_PER_PAGE=12
   ```

### 5. Lista de Verificaci√≥n Final
- [ ] Migraciones coherentes y completas
- [ ] Modelo con traits y relaciones correctas
- [ ] Request con validaciones robustas
- [ ] Controller con m√©todos organizados
- [ ] Service con l√≥gica de negocio centralizada
- [ ] API endpoints configurados
- [ ] Variables de entorno documentadas
- [ ] Rutas organizadas por contexto
- [ ] Middleware y permisos configurados
- [ ] Manejo de archivos estandarizado

## M√≥dulos Implementados

### Areas
1. **Migraciones**:
   - create_areas_table
   - add_sorting_and_meta_to_areas_table

2. **Modelo**:
   - HasMedia para gesti√≥n de im√°genes
   - SoftDeletes para papelera
   - Relaciones: user, parent, children
   - Scopes: published, featured

3. **Controller**:
   - M√©todos prefijados como public para guest, private para admin y educa para teachers y students
   - Manejo de im√°genes con collection 'cover'
   - Paginaci√≥n configurable
   - B√∫squeda integrada

4. **Servicios**:
   - AreaService: CRUD y ordenamiento
   - AreaSearchController: API de b√∫squeda

5. **Variables Entorno**:
   ```env
   COVER_ALLOWED_TYPES="jpg,jpeg,png,webp"
   COVER_MAX_FILE_SIZE=2048
   COVER_MAX_DIMENSIONS=2000
   PAGINATION_PER_PAGE=12
   ```

### √Åreas

#### Puntos Clave para la Implementaci√≥n

1. **B√∫squeda**
   - Separar los controladores de b√∫squeda por funcionalidad (normal vs trashed)
   - Mantener la misma estructura que UserSearchController como referencia inical, pero una vez que est√© funcionando AreaSearchController y TrashedAreaSearchController son una buena referenci a seguir.
   - Usar rutas con nombres consistentes: `api.areas.search` y `api.areas.trashed.search`
   - No mezclar l√≥gica de trashed en el controlador principal de b√∫squeda

2. **Modales de Confirmaci√≥n**
   - Usar el componente `x-modal-confirm` en lugar de `x-modal` b√°sico tomando como referencia los de Areas cuando existan y sino el de User que es el modelo inicial.
   - Asegurarse de incluir los par√°metros de paginaci√≥n y b√∫squeda en la URL de acci√≥n
   - Estructura del modal:
     ```blade
     <x-modal-confirm
         id="modal-id-{{ $item->id }}"
         title="T√≠tulo"
         message="Mensaje"
         :action="route('route.name', ['item' => $item, 'page' => request('page', 1), 'search' => request('search')])"
         confirm="Texto Confirmar"
         cancel="Texto Cancelar"
         method="DELETE"  // Solo si es necesario
     />
     ```
   - El bot√≥n que abre el modal debe usar:
     ```blade
     @click="$dispatch('open-modal', { id: 'modal-id-{{ $item->id }}' })"
     ```

3. **Vistas**
   - Mantener consistencia entre index y trashed
   - Reutilizar componentes como `x-search-autocomplete`
   - Pasar los par√°metros correctos a los componentes:
     ```blade
     <x-search-autocomplete 
         :route="route('admin.areas.trashed')"
         :search-url="route('api.areas.trashed.search')"
         placeholder="Buscar por nombre..." 
     />
     ```

4. **Controladores de B√∫squeda**
   - Estructura b√°sica:
     ```php
     class AreaSearchController extends SearchController
     {
         protected function getModelClass(): string
         {
             return Area::class;
         }

         protected function getSearchFields(): array
         {
             return ['name', 'description'];
         }

         protected function formatSuggestion($model): string
         {
             return $model->name;
         }

         protected function additionalConstraints($query)
         {
             // A√±adir restricciones espec√≠ficas aqu√≠
             return $query;
         }
     }
     ```

#### Lecciones Aprendidas
- Mantener la l√≥gica de trashed separada del controlador principal
- Usar componentes existentes como referencia (UserSearchController)
- Seguir patrones consistentes en rutas y nombres
- Preferir componentes predefinidos (`x-modal-confirm`) sobre implementaciones personalizadas
- Incluir siempre par√°metros de paginaci√≥n y b√∫squeda en las acciones de formularios

## üì¶ Estructura de Archivos Clave
```
proyecto2024ilerna/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ Http/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Controllers/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Auth/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Api/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UserSearchController.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AreaSearchController.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UserController.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ImageController.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProfileController.php
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AreaController.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Requests/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AreaRequest.php
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Middleware/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ EnsureRole.php
‚îÇ   ‚îú‚îÄ‚îÄ Models/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Area.php
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ User.php
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Traits/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ HasAvatar.php
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ GeneratesSlug.php
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ HasMediaTrait.php
‚îÇ   ‚îî‚îÄ‚îÄ Services/
‚îÇ       ‚îú‚îÄ‚îÄ ImageService.php
‚îÇ       ‚îî‚îÄ‚îÄ AreaService.php
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ permission.php
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îú‚îÄ‚îÄ factories/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ UserFactory.php
‚îÇ   ‚îú‚îÄ‚îÄ migrations/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 2024_10_13_181220_create_areas_table.php
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ 2024_11_23_133205_add_sorting_and_meta_to_areas_table.php
‚îÇ   ‚îî‚îÄ‚îÄ seeders/
‚îÇ       ‚îî‚îÄ‚îÄ RoleSeeder.php
‚îú‚îÄ‚îÄ resources/
‚îÇ   ‚îú‚îÄ‚îÄ css/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ app.css
‚îÇ   ‚îî‚îÄ‚îÄ views/
‚îÇ       ‚îú‚îÄ‚îÄ admin/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ users/
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.blade.php
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ form.blade.php
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ areas/
‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ ...
‚îÇ       ‚îú‚îÄ‚îÄ components/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ search-autocomplete.blade.php
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ media/
‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ avatar-upload.blade.php
‚îÇ       ‚îî‚îÄ‚îÄ layouts/
‚îÇ           ‚îú‚îÄ‚îÄ app.blade.php
‚îÇ           ‚îî‚îÄ‚îÄ navigation.blade.php
```

```
